name: Publish to NuGet

on:
  push:
    branches: [ main ]
    paths:
      - 'Directory.Build.props'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Extract version from Directory.Build.props
      id: version
      run: |
        VERSION=$(grep -oP '<Version>\K[^<]+' Directory.Build.props)
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "Detected version: $VERSION"

    - name: Check if tag already exists
      id: check_tag
      run: |
        if git ls-remote --tags origin "v${{ steps.version.outputs.version }}" | grep -q .; then
          echo "exists=true" >> "$GITHUB_OUTPUT"
          echo "Tag v${{ steps.version.outputs.version }} already exists â€” skipping publish"
        else
          echo "exists=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Setup .NET 10
      if: steps.check_tag.outputs.exists == 'false'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore
      if: steps.check_tag.outputs.exists == 'false'
      run: dotnet restore Chronex.slnx

    - name: Build
      if: steps.check_tag.outputs.exists == 'false'
      run: dotnet build Chronex.slnx --no-restore --configuration Release

    - name: Test
      if: steps.check_tag.outputs.exists == 'false'
      run: dotnet test Chronex.slnx --no-build --configuration Release --verbosity normal

    - name: Pack
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        dotnet pack src/Chronex/Chronex.csproj --no-build --configuration Release --output ./nupkg
        dotnet pack src/Chronex.Hosting/Chronex.Hosting.csproj --no-build --configuration Release --output ./nupkg

    - name: Push to NuGet
      if: steps.check_tag.outputs.exists == 'false'
      run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Create git tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git tag "v${{ steps.version.outputs.version }}"
        git push origin "v${{ steps.version.outputs.version }}"
